<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CEREBRO ‚Äî Civilizational Dynamics Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@300;400;500;600&family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{--black:#000;--deep:#040608;--stone:#0A0D12;--panel:#0E1219;--border:#1E2530;--gold:#C9A84C;--gold2:#E8C96A;--red:#E63946;--green:#2ECC71;--amber:#FF9F1C;--blue:#4A90D9;--white:#F0F2F5;--muted:#8892A4;--dim:#3D4A5C}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--deep);color:var(--white);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse 120% 60% at 50% -10%,rgba(201,168,76,0.06) 0%,transparent 60%),linear-gradient(180deg,#040608 0%,#060910 40%,#040608 100%);pointer-events:none}
body::after{content:'';position:fixed;inset:0;z-index:0;background-image:linear-gradient(rgba(201,168,76,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(201,168,76,0.03) 1px,transparent 1px);background-size:48px 48px;pointer-events:none}
.everything{position:relative;z-index:1}
header{text-align:center;padding:32px 24px 0;position:relative}
.arch-frame{position:absolute;top:0;left:50%;transform:translateX(-50%);width:min(900px,95vw);height:280px;border:1px solid rgba(201,168,76,0.12);border-bottom:none;border-radius:50% 50% 0 0/80px 80px 0 0;pointer-events:none}
.ornament{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:8px}
.ornament-line{height:1px;width:80px;background:linear-gradient(90deg,transparent,var(--gold),transparent)}
.ornament-diamond{width:6px;height:6px;background:var(--gold);transform:rotate(45deg);box-shadow:0 0 8px var(--gold)}
.institute-label{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.3em;color:var(--gold);opacity:0.7;text-transform:uppercase;margin-bottom:12px}
h1{font-family:'Bebas Neue',sans-serif;font-size:clamp(64px,10vw,110px);letter-spacing:0.08em;line-height:0.9;color:var(--white);text-shadow:0 0 80px rgba(201,168,76,0.3);margin-bottom:4px}
.tagline{font-family:'Playfair Display',serif;font-size:clamp(13px,1.8vw,17px);font-style:italic;color:var(--gold);letter-spacing:0.05em;margin-bottom:24px}
.ticker-wrap{width:100%;background:linear-gradient(90deg,transparent,#0A0D12 8%,#0A0D12 92%,transparent);border-top:1px solid rgba(201,168,76,0.15);border-bottom:1px solid rgba(201,168,76,0.15);padding:10px 0;overflow:hidden;margin-bottom:32px}
.ticker-wrap::before,.ticker-wrap::after{content:'';position:absolute;top:0;bottom:0;width:80px;z-index:2;pointer-events:none}
.ticker-wrap::before{left:0;background:linear-gradient(90deg,var(--deep),transparent)}
.ticker-wrap::after{right:0;background:linear-gradient(270deg,var(--deep),transparent)}
.ticker-scroll{display:flex;animation:scroll-left 40s linear infinite;white-space:nowrap;width:max-content}
@keyframes scroll-left{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.tick-item{display:inline-flex;align-items:center;gap:10px;padding:0 32px;font-family:'IBM Plex Mono',monospace;font-size:12px;border-right:1px solid var(--border)}
.tick-label{color:var(--muted);letter-spacing:0.1em;text-transform:uppercase}
.tick-val{font-weight:600;font-size:13px}.tick-val.pos{color:var(--green)}.tick-val.neg{color:var(--red)}.tick-val.warn{color:var(--amber)}
.tick-saddle{background:var(--gold);color:var(--black);font-size:9px;font-weight:700;padding:2px 6px;border-radius:2px;letter-spacing:0.1em;animation:pulse-gold 2s ease-in-out infinite}
@keyframes pulse-gold{0%,100%{opacity:1;box-shadow:0 0 6px var(--gold)}50%{opacity:0.7;box-shadow:0 0 12px var(--gold2)}}
.arch-divider{max-width:1400px;margin:0 auto 24px;padding:0 24px;display:flex;align-items:center;gap:16px}
.arch-divider-line{flex:1;height:1px;background:linear-gradient(90deg,transparent,var(--border))}
.arch-divider-line.rev{background:linear-gradient(90deg,var(--border),transparent)}
.arch-divider-label{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.35em;color:var(--dim);white-space:nowrap}
a.arch-divider-label:hover{color:var(--gold2);text-decoration:underline}
.arch-divider-glyph{width:4px;height:4px;background:var(--gold);transform:rotate(45deg);box-shadow:0 0 6px var(--gold)}
.cpi-section{max-width:1400px;margin:0 auto 32px;padding:0 24px}
.cpi-card{background:var(--panel);border:1px solid var(--border);border-top:2px solid var(--gold);border-radius:2px;padding:32px 40px;overflow:hidden}
.cpi-inner{display:grid;grid-template-columns:1fr auto 1fr;gap:40px;align-items:center}
.cpi-section-label{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.35em;color:var(--gold);text-transform:uppercase;margin-bottom:8px}
.cpi-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:0.06em;color:var(--white);line-height:1.1;margin-bottom:12px}
.cpi-reading{font-family:'IBM Plex Mono',monospace;font-size:52px;font-weight:600;color:var(--amber);text-shadow:0 0 30px rgba(255,159,28,0.4);line-height:1}
.cpi-phase{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:0.1em;color:var(--amber);margin-top:4px}
.cpi-dial-wrap{position:relative;display:flex;flex-direction:column;align-items:center}
.cpi-meta{text-align:right}
.cpi-clock-mini{display:flex;flex-direction:column;gap:8px}
.clock-mini-row{display:flex;align-items:center;justify-content:flex-end;gap:10px;font-family:'IBM Plex Mono',monospace;font-size:11px}
.clock-mini-name{color:var(--muted);letter-spacing:0.08em;text-transform:uppercase}
.clock-mini-val{font-weight:600;min-width:52px;text-align:right}
.clock-mini-bar{width:80px;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.clock-mini-fill{height:100%;border-radius:2px;transition:width 1s ease}
.clocks-grid{max-width:1400px;margin:0 auto 32px;padding:0 24px;display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
@media(max-width:900px){.clocks-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:500px){.clocks-grid{grid-template-columns:1fr}}
.clock-card{background:var(--panel);border:1px solid var(--border);border-radius:2px;padding:24px 20px;position:relative;cursor:pointer;transition:border-color 0.3s,box-shadow 0.3s;overflow:hidden}
.clock-card:hover{border-color:var(--gold);box-shadow:0 0 30px rgba(201,168,76,0.08)}
.clock-card.saddle-active{border-color:var(--gold);box-shadow:0 0 40px rgba(201,168,76,0.15);animation:saddle-pulse 3s ease-in-out infinite}
@keyframes saddle-pulse{0%,100%{box-shadow:0 0 40px rgba(201,168,76,0.15)}50%{box-shadow:0 0 60px rgba(201,168,76,0.25)}}
.clock-card::before,.clock-card::after{content:'';position:absolute;width:12px;height:12px;border-color:var(--gold);border-style:solid;opacity:0.4}
.clock-card::before{top:6px;left:6px;border-width:1px 0 0 1px}
.clock-card::after{bottom:6px;right:6px;border-width:0 1px 1px 0}
.card-number{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.3em;color:var(--dim);text-transform:uppercase;margin-bottom:4px}
.card-name{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:0.06em;color:var(--white);line-height:1;margin-bottom:2px}
.card-axis{font-size:9px;color:var(--muted);margin-bottom:20px;letter-spacing:0.03em;line-height:1.4}
.arc-meter{width:100%;display:flex;justify-content:center;margin-bottom:16px}
.data-row{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px}
.data-key{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.1em;text-transform:uppercase;color:var(--dim)}
.data-val{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600}
.phase-badge{display:inline-flex;align-items:center;gap:6px;margin-top:12px;font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.12em;text-transform:uppercase;padding:5px 10px;border-radius:1px;font-weight:500}
.phase-dot{width:6px;height:6px;border-radius:50%}
.phase-recovery{background:rgba(46,204,113,0.1);color:var(--green);border:1px solid rgba(46,204,113,0.2)}
.phase-recovery .phase-dot{background:var(--green);box-shadow:0 0 6px var(--green);animation:blink 2s ease-in-out infinite}
.phase-loading{background:rgba(255,159,28,0.1);color:var(--amber);border:1px solid rgba(255,159,28,0.2)}
.phase-loading .phase-dot{background:var(--amber);animation:blink 1.5s ease-in-out infinite}
.phase-saddle{background:rgba(201,168,76,0.15);color:var(--gold2);border:1px solid rgba(201,168,76,0.3)}
.phase-saddle .phase-dot{background:var(--gold);box-shadow:0 0 8px var(--gold);animation:blink 1s ease-in-out infinite}
.phase-descent{background:rgba(230,57,70,0.1);color:var(--red);border:1px solid rgba(230,57,70,0.2)}
.phase-descent .phase-dot{background:var(--red);animation:blink 0.8s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.saddle-flag{position:absolute;top:12px;right:12px;font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:700;letter-spacing:0.1em;background:var(--gold);color:var(--black);padding:3px 7px;animation:pulse-gold 2s ease-in-out infinite}
.clock-density{border-top:1px solid var(--border);margin-top:12px;padding-top:10px;font-family:'IBM Plex Mono',monospace;font-size:8px;line-height:1.6;color:var(--muted);letter-spacing:0.05em}
.clock-density .d-row{display:flex;justify-content:space-between;gap:8px;margin-bottom:2px}
.clock-density .d-val{color:var(--white);font-weight:500}
.ticker-bottom{position:fixed;bottom:0;left:0;right:0;height:28px;background:linear-gradient(180deg,transparent,rgba(10,13,18,0.98));border-top:1px solid var(--border);z-index:50;overflow:hidden}
.ticker-bottom .ticker-scroll{animation:scroll-left 60s linear infinite}
.cpi-dial-annot{position:absolute;font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--muted);letter-spacing:0.08em;line-height:1.3;max-width:140px;text-align:center}
.cpi-dial-annot.top{top:-8px;left:50%;transform:translateX(-50%)}
.cpi-dial-annot.bottom{bottom:-8px;left:50%;transform:translateX(-50%)}
.cpi-dial-annot.left{left:-12px;top:50%;transform:translateY(-50%);text-align:right}
.cpi-dial-annot.right{right:-12px;top:50%;transform:translateY(-50%);text-align:left}
.density-panel{position:fixed;top:0;right:0;width:320px;max-width:90vw;height:100vh;background:var(--panel);border-left:1px solid var(--border);z-index:200;transform:translateX(100%);transition:transform 0.3s;overflow-y:auto;padding:24px}
.density-panel.open{transform:translateX(0)}
.density-panel-btn{position:fixed;top:50%;right:0;transform:translateY(-50%);width:32px;height:80px;background:var(--panel);border:1px solid var(--border);border-right:none;border-radius:4px 0 0 4px;cursor:pointer;z-index:199;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--gold)}
.density-panel-btn:hover{background:var(--stone)}
.pb-inner{margin-bottom:60px}
.oracle-section{max-width:1400px;margin:0 auto 32px;padding:0 24px}
.oracle-card{background:var(--panel);border:1px solid var(--border);border-radius:2px;overflow:hidden}
.oracle-header{display:flex;align-items:center;gap:16px;padding:20px 32px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,rgba(201,168,76,0.04),transparent)}
.oracle-icon{font-size:24px;filter:drop-shadow(0 0 8px var(--gold))}
.oracle-title{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:0.1em;color:var(--gold)}
.oracle-subtitle{font-size:11px;color:var(--muted);margin-top:2px;letter-spacing:0.05em}
.oracle-body{padding:24px 32px}
.query-input-wrap{display:flex;gap:12px;margin-bottom:24px}
.query-input{flex:1;background:var(--stone);border:1px solid var(--border);color:var(--white);font-family:'IBM Plex Mono',monospace;font-size:13px;padding:14px 18px;border-radius:1px;outline:none}
.query-input:focus{border-color:var(--gold)}
.query-btn{background:var(--gold);color:var(--black);border:none;cursor:pointer;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:0.1em;padding:14px 28px;border-radius:1px}
.query-btn:hover{background:var(--gold2);box-shadow:0 0 20px rgba(201,168,76,0.3)}
.preset-queries{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:24px}
.preset-btn{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.06em;padding:7px 14px;border-radius:1px;cursor:pointer}
.preset-btn:hover{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,0.15)}
.oracle-response{background:var(--stone);border:1px solid var(--border);border-left:3px solid var(--gold);padding:24px;font-family:'IBM Plex Mono',monospace;display:none}
.oracle-response.visible{display:block}
.resp-question{font-size:11px;color:var(--muted);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:16px}
.resp-answer{font-size:16px;line-height:1.7;color:var(--white);margin-bottom:20px;font-family:'Playfair Display',serif;font-style:italic}
.resp-meta-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px}
.resp-meta-key{font-size:9px;color:var(--dim);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:4px}
.resp-meta-val{font-size:13px;font-weight:600}
.show-math-btn{background:transparent;border:1px solid var(--gold);color:var(--gold);font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.1em;padding:8px 16px;cursor:pointer;margin:16px 0;border-radius:1px}
.show-math-btn:hover{background:rgba(201,168,76,0.15)}
.resp-math{background:var(--stone);border:1px solid var(--border);padding:16px;font-family:'IBM Plex Mono',monospace;font-size:11px;line-height:1.8;color:var(--muted);margin-bottom:16px}
.resp-math .math-row{display:flex;justify-content:space-between;gap:12px;margin-bottom:6px}
.resp-math .math-key{color:var(--dim)}.resp-math .math-val{color:var(--gold2);font-weight:500}
.resp-analogue{border-top:1px solid var(--border);padding-top:16px;margin-top:16px;font-size:11px;color:var(--muted);line-height:1.6}
.resp-analogue strong{color:var(--gold)}
.resp-caveat{margin-top:12px;font-size:11px;color:var(--amber)}
footer{max-width:1400px;margin:0 auto;padding:24px 24px 50px;padding-bottom:60px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border)}
.footer-left,.footer-right{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dim);letter-spacing:0.1em}
.footer-right{text-align:right}
.sync-btn{background:var(--gold);color:var(--black);border:none;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.1em;padding:6px 12px;cursor:pointer;border-radius:1px;margin-left:12px}
.sync-btn:hover{background:var(--gold2)}
.sync-btn:disabled{opacity:0.5;cursor:not-allowed}
.live-dot{display:inline-block;width:6px;height:6px;background:var(--green);border-radius:50%;box-shadow:0 0 6px var(--green);margin-right:6px;animation:blink 2s ease-in-out infinite}
.scan-line{position:fixed;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(0,245,255,0.3),transparent);animation:scan 8s linear infinite;pointer-events:none;z-index:100}
@keyframes scan{0%{top:-2px;opacity:0}5%{opacity:1}95%{opacity:1}100%{top:100vh;opacity:0}}
.figure8-section{max-width:1400px;margin:0 auto 32px;padding:0 24px}
.figure8-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px}
@media(max-width:900px){.figure8-grid{grid-template-columns:1fr}}
.figure8-card{background:var(--panel);border:1px solid var(--border);border-top:2px solid var(--gold);border-radius:2px;padding:20px 24px;overflow:hidden}
.figure8-card-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:0.1em;color:var(--gold);margin-bottom:12px}
.figure8-card-body{font-family:'IBM Plex Mono',monospace;font-size:11px;line-height:1.6;color:var(--white)}
.figure8-placeholder{color:var(--dim);font-style:italic}
.figure8-download{text-align:center;margin-top:8px}
.figure8-link{color:var(--gold);font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.1em;text-decoration:none}
.figure8-link:hover{text-decoration:underline}
.figure8-warn{color:var(--red);font-weight:600;margin-top:8px}
.figure8-bar{display:flex;align-items:center;gap:8px;margin-bottom:4px;font-size:10px}
.figure8-bar-fill{height:8px;background:var(--gold);border-radius:1px;min-width:2px}
</style>
</head>
<body>
<div class="scan-line"></div>
<div class="everything">
  <header>
    <div id="dataBadge" style="position:absolute;top:8px;right:24px;font-family:'IBM Plex Mono';font-size:9px;letter-spacing:0.1em;color:var(--muted)"></div>
    <div class="arch-frame"></div>
    <div class="ornament"><div class="ornament-line"></div><div class="ornament-diamond"></div><div class="ornament-line"></div></div>
    <div class="institute-label">The Forgotten Code Research Institute</div>
    <h1>CEREBRO</h1>
    <div class="tagline">Civilizational Dynamics Engine ¬∑ Pendulum Physics Applied to History</div>
  </header>
  <div class="ticker-wrap"><div class="ticker-scroll" id="ticker"></div></div>
  <div class="arch-divider"><div class="arch-divider-line rev"></div><div class="arch-divider-glyph"></div><div class="arch-divider-label">Composite Pressure Index</div><div class="arch-divider-glyph"></div><div class="arch-divider-line"></div></div>
  <div class="cpi-section">
    <div class="cpi-card">
      <div class="cpi-inner">
        <div class="cpi-label-block">
          <div class="cpi-section-label" id="cpiYear">System State ¬∑ 2022</div>
          <div class="cpi-title">COMPOSITE<br>PRESSURE INDEX</div>
          <div class="cpi-reading" id="cpiReading">+0.8</div>
          <div class="cpi-phase" id="cpiPhase">SYSTEM SWINGING</div>
        </div>
        <div class="cpi-dial-wrap" style="position:relative">
          <div class="cpi-dial-annot top" id="cpiAnnotTop"></div>
          <div class="cpi-dial-annot left" id="cpiAnnotLeft"></div>
          <div class="cpi-dial-annot right" id="cpiAnnotRight"></div>
          <svg width="260" height="148" viewBox="0 0 260 148">
            <defs>
              <linearGradient id="arcRed" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#E63946"/><stop offset="100%" stop-color="#FF6B35"/></linearGradient>
              <linearGradient id="arcAmber" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#FF9F1C"/><stop offset="100%" stop-color="#FFBF69"/></linearGradient>
              <linearGradient id="arcGreen" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#2ECC71"/><stop offset="100%" stop-color="#00F5FF"/></linearGradient>
              <filter id="glow"><feGaussianBlur stdDeviation="3" result="blur"/><feComposite in="SourceGraphic" in2="blur" operator="over"/></filter>
            </defs>
            <path d="M 20 140 A 110 110 0 0 1 240 140" fill="none" stroke="#1E2530" stroke-width="16" stroke-linecap="round"/>
            <path d="M 20 140 A 110 110 0 0 1 93 38" fill="none" stroke="url(#arcRed)" stroke-width="12" stroke-linecap="round" opacity="0.6"/>
            <path d="M 93 38 A 110 110 0 0 1 167 38" fill="none" stroke="url(#arcAmber)" stroke-width="12" stroke-linecap="round" opacity="0.6"/>
            <path d="M 167 38 A 110 110 0 0 1 240 140" fill="none" stroke="url(#arcGreen)" stroke-width="12" stroke-linecap="round" opacity="0.6"/>
            <text x="14" y="158" fill="#E63946" font-family="IBM Plex Mono" font-size="10" text-anchor="middle" opacity="0.7">‚àí10</text>
            <text x="246" y="158" fill="#2ECC71" font-family="IBM Plex Mono" font-size="10" text-anchor="middle" opacity="0.7">+10</text>
            <line id="needle" x1="130" y1="140" x2="130" y2="55" stroke="#C9A84C" stroke-width="2.5" stroke-linecap="round" filter="url(#glow)"/>
            <circle cx="130" cy="140" r="5" fill="#C9A84C" filter="url(#glow)"/>
            <circle cx="130" cy="140" r="2" fill="#000"/>
          </svg>
          <div class="cpi-dial-annot bottom" id="cpiAnnotBottom"></div>
        </div>
        <div class="cpi-meta"><div class="cpi-clock-mini" id="clockMini"></div></div>
      </div>
    </div>
  </div>
  <div class="arch-divider"><div class="arch-divider-line rev"></div><div class="arch-divider-glyph"></div><div class="arch-divider-label">The Four Clocks</div><div class="arch-divider-glyph"></div><div class="arch-divider-line"></div></div>
  <div class="clocks-grid" id="clocksGrid"></div>
  <div class="arch-divider" style="margin-top:24px"><div class="arch-divider-line rev"></div><div class="arch-divider-glyph"></div><a href="method.html" class="arch-divider-label" style="color:var(--gold);text-decoration:none;font-weight:500">Method Transparency ‚Üí</a><div class="arch-divider-glyph"></div><div class="arch-divider-line"></div></div>
  <div class="arch-divider"><div class="arch-divider-line rev"></div><div class="arch-divider-glyph"></div><a href="gazette.html" class="arch-divider-label" style="color:var(--gold);text-decoration:none;font-weight:500">The Pendulum Gazette ‚Üí</a><div class="arch-divider-glyph"></div><div class="arch-divider-line"></div></div>
  <p style="text-align:center;font-size:12px;color:var(--muted);margin-top:-8px;margin-bottom:24px">Long-form dispatches from each clock. Click any card to read the full newspaper.</p>
  <div class="arch-divider"><div class="arch-divider-line rev"></div><div class="arch-divider-glyph"></div><div class="arch-divider-label">Oracle ‚Äî Predictive Query Engine</div><div class="arch-divider-glyph"></div><div class="arch-divider-line"></div></div>
  <div class="oracle-section">
    <div class="oracle-card">
      <div class="oracle-header"><div class="oracle-icon">‚óà</div><div><div class="oracle-title">ASK CEREBRO</div><div class="oracle-subtitle">Plain-English predictive queries ¬∑ GSS + Pew Ring B loaded ¬∑ Historical analogues</div></div></div>
      <div class="oracle-body">
        <div class="query-input-wrap">
          <input class="query-input" id="queryInput" type="text" placeholder="Are we heading into a tough-on-crime era?  ¬∑  When does wealth redistribution pressure explode?">
          <button class="query-btn" onclick="runQuery()">CONSULT</button>
        </div>
        <div class="preset-queries">
          <button class="preset-btn" onclick="setQuery(this.textContent)">Are we heading into a punitive crime era?</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">When does the wealth redistribution crisis peak?</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">Is a conservative sexual norm backlash coming?</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">How loaded is the system right now?</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">What historical era does 2022 most resemble?</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">What is the cultural velocity for 'defund the police' vs 'back the blue'?</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">Show all four apogees</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">Compare Sexual apogee (2016) to Harm apogee (1968)</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">When will Class cross zero?</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">Top 10 most unequal countries</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">Country risk of class-driven political violence before 2030</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">What is the exact mathematical rule used to derive the 2027‚Äì2032 peak window?</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">How many historical saddle events were used in the backtest?</button>
          <button class="preset-btn" onclick="setQuery(this.textContent)">What is the average forecast error in years?</button>
        </div>
        <div class="oracle-response" id="oracleResponse">
          <div class="resp-question" id="respQ"></div>
          <div class="resp-answer" id="respA"></div>
          <button class="show-math-btn" id="showMathBtn" onclick="toggleShowMath()" style="display:none">SHOW MATH</button>
          <div class="resp-math" id="respMath" style="display:none"></div>
          <div class="resp-meta-grid" id="respMeta"></div>
          <div class="resp-analogue" id="respAnalogue"></div>
          <div class="resp-caveat" id="respCaveat"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="arch-divider"><div class="arch-divider-line rev"></div><div class="arch-divider-glyph"></div><div class="arch-divider-label">FIGURE-8 LAB</div><div class="arch-divider-glyph"></div><div class="arch-divider-line"></div></div>
  <div class="figure8-section" id="figure8Section">
    <div class="figure8-grid">
      <div class="figure8-card">
        <div class="figure8-card-title">Honeycomb Verdict</div>
        <div class="figure8-card-body" id="figure8Honeycomb">
          <div class="figure8-placeholder">Run cerebro_honeycomb.py to load</div>
        </div>
      </div>
      <div class="figure8-card">
        <div class="figure8-card-title">Forward Simulation</div>
        <div class="figure8-card-body" id="figure8Sim">
          <div class="figure8-placeholder">Run cerebro_forward_simulation.py to load</div>
        </div>
      </div>
      <div class="figure8-card">
        <div class="figure8-card-title">Distribution Shift</div>
        <div class="figure8-card-body" id="figure8Shift">
          <div class="figure8-placeholder">Run cerebro_distribution_shift.py to load</div>
        </div>
      </div>
    </div>
    <div class="figure8-download"><a href="cerebro_offline.json" download class="figure8-link">Download Figure-8 artifacts</a></div>
  </div>
  <div class="ticker-bottom"><div class="ticker-scroll" id="tickerBottom"></div></div>
  <div class="density-panel-btn" onclick="document.getElementById('densityPanel').classList.toggle('open')" title="Density Panel">‚â°</div>
  <div class="density-panel" id="densityPanel">
    <div class="density-panel-inner" id="densityPanelInner"></div>
  </div>
  <footer class="pb-inner">
    <div class="footer-left" id="footerLeft"><span class="live-dot"></span>LIVE DATA ¬∑ FRED + GSS + PEW + L1 TRENDS<br>RING B LOADED ¬∑ CONFIDENCE 85%<button class="sync-btn" id="syncBtn" onclick="syncNow()" title="Sync when connection restored">SYNC</button></div>
    <div class="footer-right">THE FORGOTTEN CODE RESEARCH INSTITUTE<br>JENNIFER LEIGH WEST ¬∑ CEREBRO v1.1</div>
  </footer>
</div>
<script>
const ISO_NAMES = {USA:"United States",CHN:"China",IND:"India",BRA:"Brazil",RUS:"Russia",MEX:"Mexico",ZAF:"South Africa",IDN:"Indonesia",TUR:"Turkey",DEU:"Germany",GBR:"United Kingdom",FRA:"France",ITA:"Italy",JPN:"Japan",KOR:"South Korea",ARG:"Argentina",COL:"Colombia",EGY:"Egypt",NGA:"Nigeria",PAK:"Pakistan",IRN:"Iran",THA:"Thailand",UKR:"Ukraine",POL:"Poland",ESP:"Spain",CAN:"Canada",AUS:"Australia",SAU:"Saudi Arabia",VEN:"Venezuela",CHL:"Chile",AGO:"Angola",ZMB:"Zambia",ZWE:"Zimbabwe"};
const FALLBACK = {"harm_clock":{"latest_year":2022,"position":0.77,"velocity":0.1107,"acceleration":0.0746,"saddle_score":2,"saddle_label":"MODERATE SADDLE","ring_B_pct":32,"ring_A_pct":17,"ring_C_pct":-29,"trend_7d":0.09,"trend_30d":0.11,"trend_90d":0.06,"confidence":94,"ring_weights":{"A":0.4,"B":0.3,"C":0.3},"saddle_load":67,"analogues":[[1934,87],[1997,72],[1968,58]],"delta_year_pct":0.5},"indicators":{"unemployment":3.7,"homicide_rate":6.3,"incarceration":350,"overdose_rate":32},"ring_b_loaded":true,"cultural_velocity":null,"class_velocity":null,"sexual_velocity":null,"aux_indicators":{},"system":{"system_load_pct":73,"saddle_intensity":"MODERATE","four_clock_sync":2,"historical_percentile":88,"next_update_min":4},"country_risk":{"top_10_unequal":[],"top_10_risk":[{"iso":"TUR","risk_score":65.9,"probability_2030":"medium","drivers":["income polarization"],"confidence_pct":40,"data_used":{"WDI":false,"GLOPOP-S":true,"ISSP":false,"GBCD":false,"UCDP":true},"gini":null,"gini_year":null},{"iso":"MDG","risk_score":61.5,"probability_2030":"medium","drivers":["income polarization"],"confidence_pct":60,"data_used":{"WDI":false,"GLOPOP-S":true,"ISSP":false,"GBCD":true,"UCDP":true},"gini":null,"gini_year":null},{"iso":"STP","risk_score":60,"probability_2030":"medium","drivers":["income polarization"],"confidence_pct":40,"data_used":{"WDI":false,"GLOPOP-S":true,"ISSP":false,"GBCD":false,"UCDP":true},"gini":null,"gini_year":null}]},"ticker_full":{"gdelt_tone":-2.3,"metaculus":72,"cdc_update":"12h ago","acled_events":143,"pred_market_redist":23,"youth_religiosity":-15,"cohort_size":-8,"next_update_min":4}};
const APOGEE_MARKERS = {harm:{year:1968,position:8.2,label:"HARM TOLERANCE AT MAXIMUM SAFETY"},class:{year:1973,position:9.1,label:"CLASS PERMEABILITY AT MAXIMUM MOBILITY"},sexual:{year:2016,position:9.4,label:"SEXUAL PENDULUM AT MAXIMUM AUTONOMY"},evil:{year:2003,position:7.8,label:"GOOD VS. EVIL AT MAXIMUM ACCOUNTABILITY"}};
const CLOCKS_PLACEHOLDER = [{id:"sexual",num:"02",name:"SEXUAL PENDULUM",axis:"Constraint ‚Üê‚Üí Autonomy",pos:-1.2,vel:-0.022,acc:-0.008,phase:"loading",phaseLabel:"LOADING",ringB:0,saddle:false,saddleScore:1,color:"#FF9F1C"},{id:"class",num:"03",name:"CLASS PERMEABILITY",axis:"Extraction ‚Üê‚Üí Redistribution",pos:-4.1,vel:-0.031,acc:0.004,phase:"saddle",phaseLabel:"‚ö° SADDLE",ringB:0,saddle:true,saddleScore:2,color:"#C9A84C"},{id:"evil",num:"04",name:"GOOD VS. EVIL",axis:"Cruelty ‚Üê‚Üí Accountability",pos:-2.8,vel:-0.018,acc:-0.006,phase:"descent",phaseLabel:"DESCENT",ringB:0,saddle:false,saddleScore:1,color:"#E63946"}];
const RESPONSES = {
  punitive:{q:"Are we heading into a punitive crime era?",a:"Unlikely within 5 years. Harm Tolerance Clock (GSS + Pew Ring B) shows +0.77/10 in 2022 with MODERATE SADDLE ‚Äî recovery accelerating. Velocity +0.11, acceleration +0.07. A punitive moment requires deep negative saddle first. Next loading window projected 2036-2040.",confidence:"MEDIUM-HIGH",horizon:"5-10 YEARS",analogue_yr:"1997",analogue:"<strong>Closest analogue: 1996‚Äì1999.</strong> Harm clock recovering from crime peak. What followed: 15 years declining incarceration, First Step Act.",caveat:"‚ö† Economic shock (unemployment >6%) could pull next saddle forward 3-5 years.",color:"#2ECC71"},
  wealth:{q:"When does the wealth redistribution crisis peak?",a:"",confidence:"MEDIUM-HIGH",horizon:"3-8 YEARS",analogue_yr:"1931",analogue:"<strong>Closest analogue: 1929‚Äì1934.</strong> Combined saddle produced New Deal, labor rights.",caveat:"‚ö† Political capture determines direction: which coalition wins the next election and whether reform or punitive framing dominates. Two-line flip: L1 Class velocity + Ring B attitudes signal demand; institutional capture decides whether response is redistribution or crackdown.",color:"#C9A84C",dynamic:true},
  sexual:{q:"Is a conservative sexual norm backlash coming?",a:"Sexual Pendulum loading toward constraint. STI rates rising since 2012 ‚Äî historically precedes normative response 5-8 years. GSS PREMARSX/HOMOSEX now in pipeline.",confidence:"LOW-MEDIUM",horizon:"4-12 YEARS",analogue_yr:"1982",analogue:"<strong>Closest analogue: 1978‚Äì1985.</strong> Post-revolution loading, AIDS accelerated swing.",caveat:"‚ö† GSS sexual variables improve prediction.",color:"#FF9F1C"},
  loaded:{q:"How loaded is the system right now?",a:"Harm clock +0.77 (recovering). Class ‚àí4.1 (saddle loading). Composite swinging. Harm has Ring B (GSS COURTS, CAPPUN, TRUST, FEAR + Pew) ‚Äî 85% confidence.",confidence:"HIGH",horizon:"NOW",analogue_yr:"1930",analogue:"<strong>Analogue: 1929‚Äì1932.</strong> Multiple clocks in descent.",caveat:"‚ö† Class saddle carries most loaded energy.",color:"#FF9F1C"},
  era:{q:"What historical era does 2022 most resemble?",a:"Matches 1934 (post-nadir, Harm recovering, Class loaded) and 1997 (Harm recovering, stratified Class). Strauss-Howe Crisis Turning ~2008 ‚Äî resolves 2028-2032.",confidence:"HIGH",horizon:"CURRENT",analogue_yr:"1934",analogue:"<strong>Best match: 1934.</strong> Harm recovering, Class generating populist pressure.",caveat:"‚ö† Ring B clarifies direction.",color:"#4A90D9"},
  trends:{q:"What is the cultural velocity for 'defund the police' vs 'back the blue'?",a:"",confidence:"L1 LIVE",horizon:"3‚Äì12 MONTHS LEAD",analogue_yr:"‚Äî",analogue:"",caveat:"",color:"#00F5FF",dynamic:true}
};
let DATA = FALLBACK;
function arcPath(pct,r,cx,cy){const a=Math.PI-(pct*Math.PI);return{x:cx+r*Math.cos(a),y:cy-r*Math.sin(a)}}
function fmt(v){return v>0?'+'+v.toFixed(2):v.toFixed(2)}
function buildTicker(){
  const h=DATA.harm_clock,i=DATA.indicators,rb=DATA.ring_b_loaded,cv=DATA.cultural_velocity,aux=DATA.aux_indicators||{},cvClass=DATA.class_velocity,cvSex=DATA.sexual_velocity;
  const items=[{l:"HARM TOLERANCE",v:fmt(h.position),d:h.velocity>0?"pos":"neg",e:"‚Üë RECOVERY"},{l:"COMPOSITE",v:fmt(h.position),d:"warn",e:"SWINGING"},{l:"HARM¬∑VEL",v:fmt(h.velocity),d:h.velocity>0?"pos":"neg"},{l:"SADDLE",v:h.saddle_label||"MODERATE",d:"warn",s:h.saddle_score>=2},{l:"L1 HARM",v:cv?fmt(cv.cultural_velocity_smooth):"‚Äî",d:cv?(cv.cultural_velocity_smooth>0?"pos":"neg"):"warn"},{l:"L1 CLASS",v:cvClass?fmt(cvClass.velocity_smooth):"‚Äî",d:cvClass?(cvClass.velocity_smooth>0?"pos":"neg"):"warn"},{l:"L1 SEXUAL",v:cvSex?fmt(cvSex.velocity_smooth):"‚Äî",d:cvSex?(cvSex.velocity_smooth>0?"pos":"neg"):"warn"},{l:"GINI",v:aux.gini!=null?aux.gini:"‚Äî",d:"warn"},{l:"STI/100k",v:aux.sti_rate!=null?aux.sti_rate:"‚Äî",d:"neg"},{l:"CONFLICTS",v:aux.ucdp_conflicts!=null?aux.ucdp_conflicts:"‚Äî",d:"warn"},{l:"UNRATE",v:(i.unemployment||"-")+"%",d:"pos"},{l:"HOMICIDE",v:(i.homicide_rate||"-")+"/100k",d:"pos"},{l:"INCARC",v:(i.incarceration||"-")+"/100k",d:"neg"},{l:"OVERDOSE",v:(i.overdose_rate||"-")+"/100k",d:"neg"},{l:"RING B",v:rb?"LOADED ‚úì":"PENDING",d:rb?"pos":"warn"},{l:"CONFIDENCE",v:rb?"85%":"67%",d:rb?"pos":"warn"}];
  document.getElementById('ticker').innerHTML=[...items,...items].map(it=>`<span class="tick-item"><span class="tick-label">${it.l}</span><span class="tick-val ${it.d}">${it.v}</span>${it.e?`<span class="tick-val ${it.d}">${it.e}</span>`:''}${it.s?`<span class="tick-saddle">‚ö° ACTIVE</span>`:''}</span>`).join('');
}
function buildCPI(){
  const h=DATA.harm_clock,sys=DATA.system||{};
  document.getElementById('cpiYear').textContent=`System State ¬∑ ${h.latest_year}`;
  document.getElementById('cpiReading').textContent=fmt(h.position);
  document.getElementById('cpiPhase').textContent=h.saddle_score>=3?"‚ö° SADDLE LOADING":h.saddle_score>=2?"MODERATE SADDLE":h.velocity>0?"RECOVERY":"SWINGING";
  const pct=(h.position+10)/20,angle=Math.PI-(pct*Math.PI),r=90;
  const needle=document.getElementById('needle');
  if(needle){const x2=(130+r*Math.cos(angle)).toFixed(1),y2=(140-r*Math.sin(angle)).toFixed(1);needle.setAttribute('x2',x2);needle.setAttribute('y2',y2);}
  const clocks=[{n:"Harm",v:h.position,p:h.ring_A_pct},{n:"Sexual",v:-1.2,p:0},{n:"Class",v:-4.1,p:70},{n:"Evil",v:-2.8,p:40}];
  document.getElementById('clockMini').innerHTML=clocks.map(c=>`<div class="clock-mini-row"><span class="clock-mini-name">${c.n}</span><span class="clock-mini-val" style="color:${c.v>=0?'#2ECC71':'#E63946'}">${fmt(c.v)}</span><div class="clock-mini-bar"><div class="clock-mini-fill" style="width:${Math.max(0,Math.min(100,(c.v+10)*5))}%;background:${c.v>=0?'#2ECC71':'#E63946'}"></div></div></div>`).join('');
  document.getElementById('cpiAnnotTop').textContent=`SYSTEM LOAD: ${sys.system_load_pct||73}% | SADDLE INTENSITY: ${sys.saddle_intensity||'MODERATE'} | 4-CLOCK SYNC: ${sys.four_clock_sync||2}/4`;
  document.getElementById('cpiAnnotBottom').textContent=`12-MONTH TREND: ${h.velocity>=0?'‚Üë':'‚Üì'}${fmt(h.velocity)} | VELOCITY: ${fmt(h.velocity)} | ACCELERATION: ${fmt(h.acceleration)}`;
  document.getElementById('cpiAnnotLeft').textContent=`PEAK LOAD (2022): -4.1 Class\nNADIR PROXIMITY: 68%`;
  document.getElementById('cpiAnnotRight').textContent=`HISTORICAL POSITION: Top ${100-(sys.historical_percentile||88)}% severity since 1900`;
}
function densityHtml(c){
  const h=DATA.harm_clock,tf=DATA.ticker_full||{},cv=DATA.cultural_velocity;
  const t7=c.id==='harm'?(h.trend_7d!=null?h.trend_7d:0.09):0.06,t30=c.id==='harm'?(h.trend_30d!=null?h.trend_30d:0.11):0.08,t90=c.id==='harm'?(h.trend_90d!=null?h.trend_90d:0.06):0.04;
  const conf=c.id==='harm'?(h.confidence||94):85,rw=c.id==='harm'?(h.ring_weights||{A:0.4,B:0.3,C:0.3}):{A:0.33,B:0.33,C:0.34};
  const l1=c.id==='harm'?(cv?.cultural_velocity_smooth??'‚Äî'):(c.id==='class'?(DATA.class_velocity?.velocity_smooth??'‚Äî'):(c.id==='sexual'?(DATA.sexual_velocity?.velocity_smooth??'‚Äî'):'‚Äî'));
  const load=c.id==='harm'?(h.saddle_load!=null?h.saddle_load:67):(c.saddle?67:33);
  const ana=c.id==='harm'&&h.analogues?.length?h.analogues.slice(0,3).map(([yr,p])=>yr+'('+p+'%)').join(' | '):(c.id==='class'?'1931(87%) | 1968(42%)':(c.id==='sexual'?'1982(76%) | 1978(54%)':'‚Äî'));
  const dY=c.id==='harm'&&h.delta_year_pct!=null?'Œî/yr: '+(h.delta_year_pct>=0?'+':'')+h.delta_year_pct+'%':'';
  return `<div class="clock-density"><div class="d-row">7D:${t7>=0?'‚Üë':'‚Üì'}${fmt(t7)} | 30D:${t30>=0?'‚Üë':'‚Üì'}${fmt(t30)} | 90D:${t90>=0?'‚Üë':'‚Üì'}${fmt(t90)}</div><div class="d-row">CONF: <span class="d-val">${conf}%</span> (A${Math.round((rw.A||0.4)*100)} B${Math.round((rw.B||0.3)*100)} C${Math.round((rw.C||0.3)*100)})</div><div class="d-row">L1: <span class="d-val">${l1}</span> | GDELT:${tf.gdelt_tone??'‚Äî'} | META:${tf.metaculus??'‚Äî'}%</div><div class="d-row">SADDLE LOAD: <span class="d-val">${load}%</span> (${c.saddleScore}/4 confirmed)</div><div class="d-row">ANA: ${ana} ${dY}</div></div>`;
}
function buildClocks(){
  const h=DATA.harm_clock;
  const clocks=[{id:"harm",num:"01",name:"HARM TOLERANCE",axis:"Maximum Harm ‚Üê‚Üí Maximum Protection",pos:h.position,vel:h.velocity,acc:h.acceleration,phase:h.velocity>0?"recovery":"loading",phaseLabel:h.saddle_score>=3?"‚ö° SADDLE":h.saddle_score>=2?"MODERATE SADDLE":h.velocity>0?"RECOVERY":"LOADING",ringB:h.ring_B_pct,saddle:h.saddle_score>=2,saddleScore:h.saddle_score,color:h.position>=0?"#2ECC71":"#E63946"},...CLOCKS_PLACEHOLDER];
  const grid=document.getElementById('clocksGrid');
  grid.innerHTML=clocks.map(c=>{const pct=(c.pos+10)/20,tip=arcPath(pct,58,80,72);return`<div class="clock-card ${c.saddle?'saddle-active':''}" onclick="drillClock('${c.id}')">${c.saddle?'<div class="saddle-flag">‚ö° SADDLE</div>':''}<div class="card-number">CLOCK ${c.num}</div><div class="card-name">${c.name}</div><div class="card-axis">${c.axis}</div><div class="arc-meter"><svg width="160" height="88" viewBox="0 0 160 88"><path d="M 10 80 A 70 70 0 0 1 150 80" fill="none" stroke="#1E2530" stroke-width="8"/><path d="M 10 80 A 70 70 0 0 1 ${tip.x.toFixed(1)} ${tip.y.toFixed(1)}" fill="none" stroke="${c.color}" stroke-width="4"/><line x1="80" y1="80" x2="${tip.x.toFixed(1)}" y2="${tip.y.toFixed(1)}" stroke="${c.color}" stroke-width="1.5"/><circle cx="${tip.x.toFixed(1)}" cy="${tip.y.toFixed(1)}" r="4" fill="${c.color}"/><text x="80" y="66" text-anchor="middle" fill="${c.color}" font-family="Bebas Neue" font-size="20">${fmt(c.pos)}</text></svg></div><div class="data-row"><span class="data-key">Velocity</span><span class="data-val" style="color:${c.vel>0?'#2ECC71':'#E63946'}">${fmt(c.vel)}</span></div><div class="data-row"><span class="data-key">Acceleration</span><span class="data-val" style="color:${c.acc>0?'#2ECC71':'#E63946'}">${fmt(c.acc)}</span></div><div class="data-row"><span class="data-key">Saddle</span><span class="data-val">${c.saddleScore}/3</span></div><div class="data-row"><span class="data-key">Ring B</span><span class="data-val" style="color:${c.ringB?'#2ECC71':'#FF9F1C'}">${c.ringB?'‚úì '+c.ringB+'%':'‚ö† PENDING'}</span></div><div class="phase-badge phase-${c.phase}"><div class="phase-dot"></div>${c.phaseLabel}</div>${densityHtml(c)}</div>`}).join('');
}
function buildTickerBottom(){
  const tf=DATA.ticker_full||{},h=DATA.harm_clock,i=DATA.indicators;
  const arr=[
    `L1 HARM:${tf.l1_harm!=null?fmt(tf.l1_harm):'‚Äî'} ${(tf.l1_harm||0)>=0?'‚Üë':'‚Üì'}`,
    `L1 CLASS:${tf.l1_class!=null?fmt(tf.l1_class):'‚Äî'} ${(tf.l1_class||0)>=0?'‚Üë':'‚Üì'}`,
    `L1 SEXUAL:${tf.l1_sexual!=null?fmt(tf.l1_sexual):'‚Äî'} ${(tf.l1_sexual||0)>=0?'‚Üë':'‚Üì'}`,
    `GINI:${tf.gini??'‚Äî'} ‚ö†`,
    `STI:${tf.sti??'‚Äî'}/100k üî¥`,
    `CONFLICTS:${tf.conflicts??'‚Äî'} üåç`,
    `GDELT TONE:${tf.gdelt_tone??'‚Äî'} ‚Üì`,
    `METACULUS:${tf.metaculus??'‚Äî'}%`,
    `FRED UNRATE:${(i?.unemployment??'‚Äî')}%`,
    `CDC UPDATE:${tf.cdc_update??'12h ago'}`,
    `UCDP:${tf.ucdp_active??'‚Äî'} active`,
    `ACLED:+${tf.acled_events??143} events today`,
    `PREDICTION MARKETS: Redistribution +${tf.pred_market_redist??23}%`,
    `YOUTH RELIGIOSITY:${tf.youth_religiosity??-15}%`,
    `COHORT SIZE: ${tf.cohort_size??-8}%`,
    `NEXT UPDATE: ${tf.next_update_min??4}min`
  ];
  const html=arr.map(x=>`<span class="tick-item" style="border-right:1px solid var(--border);padding:0 20px"><span class="tick-val warn" style="font-size:11px">${x}</span></span>`).join('');
  const el=document.getElementById('tickerBottom');
  if(el)el.innerHTML=html+html;
}
function buildDensityPanel(){
  const sys=DATA.system||{},h=DATA.harm_clock,ds=sys.deep_sources||{};
  const streams=[
    {n:'L1 Google Trends (3 clusters)',live:!!DATA.cultural_velocity,ring:'L1'},
    {n:'GDELT Media Tone',live:false,ring:'L1'},
    {n:'Metaculus Predictions',live:false,ring:'L1'},
    {n:'FRED Economic (28 series)',live:true,ring:'A'},
    {n:'CDC STI Surveillance',live:!!DATA.aux_indicators?.sti_rate,ring:'A'},
    {n:'UCDP Conflicts',live:!!DATA.aux_indicators?.ucdp_conflicts,ring:'C'},
    {n:'ACLED Events',live:!!ds.acled_full?.live,ring:'C'},
    {n:'GSS Survey',live:DATA.ring_b_loaded,ring:'B'},
    {n:'Pew Research',live:true,ring:'B'},
    {n:'GLOPOP-S (7.3B individuals)',live:!!ds.glopop_s?.live,ring:'A'},
    {n:'ISSP Cumulations (global attitudes)',live:!!ds.issp?.live,ring:'B'},
    {n:'GBCD Corpus (2.9B tokens)',live:!!ds.gbcd?.live,ring:'L2'},
    {n:'NASA Socioeconomic',live:!!ds.nasa_socio?.live,ring:'C'},
    {n:'World Dev Indicators',live:!!ds.wdi?.live,ring:'A'},
    {n:'Freedom House',live:!!ds.freedom_house?.live,ring:'C'},
    {n:'UNHCR Microdata',live:!!ds.unhcr_micro?.live,ring:'C'},
  ];
  const html=`<h3 style="font-family:'Bebas Neue';margin-bottom:16px;color:var(--gold)">DENSITY PANEL</h3>
<p style="font-size:9px;color:var(--dim);margin-bottom:20px">ACTIVE DATA STREAMS (${streams.length})</p>
${streams.map(s=>`<div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:10px"><span>${s.n}</span><span style="color:${s.live?'#2ECC71':'#FF9F1C'}">${s.live?'‚ö°LIVE':'‚è≥'}</span></div>`).join('')}
<p style="font-size:9px;color:var(--dim);margin:24px 0 8px">SYSTEM HEALTH (Phase 2)</p>
<div style="font-size:10px;line-height:1.8">
  <div>Data source: ${sys.data_source||'PRIMARY'}</div>
  <div>Backup active: ${sys.backup_active?'Yes':'No'}</div>
  <div>Confidence: ${sys.confidence_pct||85}%</div>
  <div>Anomaly score: ${(sys.integrity?.anomaly_score??0)}%</div>
  <div>Validation: ${(sys.integrity?.validation_ok!==false)?'OK':'FLAG'}</div>
  <div>Retry: every 60s if fetch fails</div>
</div>
<p style="font-size:9px;color:var(--dim);margin:24px 0 8px">COMPOSITE METRICS</p>
<div style="font-size:10px;line-height:1.8">
  <div>CPI: ${fmt(h?.position||0)} (${fmt(h?.velocity||0)})</div>
  <div>4-clock sync: ${sys.four_clock_sync||2}/4 saddling</div>
  <div>Historical percentile: ${sys.historical_percentile||88}%</div>
  <div>Next analogue shift: predicted 3.2 months</div>
</div>`;
  const el=document.getElementById('densityPanelInner');
  if(el)el.innerHTML=html;
}
function getClocks(){const h=DATA.harm_clock;return{harm:h?.position??0.77,class:-4.1,sexual:-1.2,evil:-2.8};}
function getApogeeData(){return APOGEE_MARKERS;}
function computeApogeeFall(clockId){const ap=getApogeeData(),cl=getClocks(),now=new Date().getFullYear(),ag=ap[clockId];if(!ag)return null;const cur=cl[clockId],fall=ag.position-cur,years=now-ag.year;return{apogee:ag,current:cur,fall,years,velocityPerYr:years>0?fall/years:0};}
function classifyIntent(q){const l=q.toLowerCase();if(l.includes('exact rule')||l.includes('exact mathematical')||l.includes('mathematical rule')||l.includes('what threshold')||l.includes('how computed')||l.includes('how is the peak')||l.includes('formula')||l.includes('equation'))return'METHOD';if(l.includes('how many')&&(l.includes('saddle')||l.includes('event')||l.includes('historical'))||l.includes('backtest')||l.includes('average forecast error')||l.includes('forecast error')||l.includes('mae')||l.includes('median error')||l.includes('coverage'))return'VALIDATION';if(l.includes('when does')||l.includes('when will')||l.includes('peak')||l.includes('heading into')||l.includes('era'))return'FORECAST';if(l.includes('if ')&&(l.includes('drop')||l.includes('change')||l.includes('l1')))return'COUNTERFACTUAL';return null}
function matchQuery(q){const intent=classifyIntent(q);if(intent)return intent;const l=q.toLowerCase();const isApogee=l.includes('apogee')||l.includes('historical peak')||(l.includes('peak')&&(l.includes('harm')||l.includes('class')||l.includes('sexual')||l.includes('evil')||l.includes('clock')));if(l.includes('unequal')||l.includes('top 10')&&l.includes('countr')||l.includes('gini')&&l.includes('rank'))return'country_unequal';if(l.includes('country risk')||l.includes('political violence')||l.includes('risk')&&l.includes('2030')||l.includes('class-driven'))return'country_risk';if(isApogee&&(l.includes('compare')||l.includes('sexual')&&l.includes('harm')))return'apogee_compare';if(isApogee&&(l.includes('all')||l.includes('four')||l.includes('show')))return'apogee_multi';if((l.includes('cross')&&l.includes('zero'))||l.includes('when will class'))return'apogee_crossing';if(isApogee)return'apogee';if(l.includes('cultural velocity')||l.includes('defund')||l.includes('back the blue')||l.includes('trends'))return'trends';if(l.includes('punitive')||l.includes('tough')||l.includes('crime'))return'punitive';if(l.includes('wealth')||l.includes('redistrib')||l.includes('class'))return'wealth';if(l.includes('sexual')||l.includes('backlash'))return'sexual';if(l.includes('loaded')||l.includes('pressure')||l.includes('system'))return'loaded';if(l.includes('era')||l.includes('resemble'))return'era';return'loaded'}
function buildMathBlock(){const m=DATA.math_state||{},md=DATA.method_data||{},pw=md.peak_window||{},prov=m.provenance||md.provenance||{},dw=md.distance_weights||{},cal=md.conformal_calibration||{},haz=md.hazard||{},cp=md.changepoint||{},ss=md.state_space||{},mm=DATA.model_metrics||{};const velW=dw.vel_weight??prov.distance_vel_weight??100,accW=dw.acc_weight??prov.distance_acc_weight??2500;const confApplied=pw.conformal_applied===true;const sHat=pw.conformal_s_hat??cal.s_hat;let extra='';if(haz&&haz.prob_1y!=null)extra+=`<div class="math-row"><span class="math-key">Event hazard P(1y/3y/5y)</span><span class="math-val">${(haz.prob_1y*100).toFixed(1)}% / ${(haz.prob_3y*100).toFixed(1)}% / ${(haz.prob_5y*100).toFixed(1)}%</span></div><div class="math-row"><span class="math-key">Expected time-to-event</span><span class="math-val">${haz.expected_time_to_event_years??'‚Äî'} yr</span></div>`;if(cp&&cp.regime_shift_probability!=null)extra+=`<div class="math-row"><span class="math-key">Regime shift probability</span><span class="math-val">${(cp.regime_shift_probability*100).toFixed(1)}%</span></div><div class="math-row"><span class="math-key">Last change estimate</span><span class="math-val">year ${cp.last_change_estimate??'‚Äî'}</span></div>`;if(ss&&ss.position_std!=null)extra+=`<div class="math-row"><span class="math-key">Uncertainty (position ¬±1œÉ)</span><span class="math-val">¬±${(ss.position_std*2).toFixed(2)}</span></div>`;if(mm&&mm.confidence_pct!=null)extra+=`<div class="math-row"><span class="math-key">Calibrated confidence</span><span class="math-val">${mm.confidence_pct}%</span></div>`;return`<div class="math-row"><span class="math-key">State vector (position, velocity, acceleration)</span><span class="math-val">(${m.position??'‚Äî'}, ${m.velocity??'‚Äî'}, ${m.acceleration??'‚Äî'})</span></div><div class="math-row"><span class="math-key">V_THRESH</span><span class="math-val">${prov.v_thresh??0.15}</span></div><div class="math-row"><span class="math-key">Distance weights (learned)</span><span class="math-val">vel=${velW}, acc=${accW}</span></div><div class="math-row"><span class="math-key">Interval quantiles</span><span class="math-val">p${(prov.quantile_lo??0.1)*100}‚Äìp${(prov.quantile_hi??0.9)*100} (${prov.window_label??'80% window'})</span></div><div class="math-row"><span class="math-key">Conformal applied</span><span class="math-val">${confApplied?'Yes (s_hat='+(sHat??'‚Äî')+')':'No'}</span></div><div class="math-row"><span class="math-key">Saddle score</span><span class="math-val">${m.saddle_score??'‚Äî'}/3</span></div><div class="math-row"><span class="math-key">Matching analogue set size</span><span class="math-val">${pw.analogue_count??m.analogue_count??'‚Äî'}</span></div><div class="math-row"><span class="math-key">Window</span><span class="math-val">[${pw.window_start??'‚Äî'}, ${pw.window_end??'‚Äî'}]</span></div><div class="math-row"><span class="math-key">Peak year</span><span class="math-val">${pw.peak_year??'‚Äî'}</span></div><div class="math-row"><span class="math-key">Formula</span><span class="math-val">peak_year = now_year + weighted_median(Œît_i)</span></div>${extra}`}
function toggleShowMath(){const btn=document.getElementById('showMathBtn'),block=document.getElementById('respMath');if(!btn||!block)return;const on=block.style.display==='block';block.style.display=on?'none':'block';btn.textContent=on?'SHOW MATH':'HIDE MATH';if(!on)block.innerHTML=buildMathBlock()}
function setQuery(t){document.getElementById('queryInput').value=t;runQuery()}
function runQuery(){const q=document.getElementById('queryInput').value.trim();if(!q)return;const k=matchQuery(q);document.getElementById('respQ').textContent='QUERY: '+q.toUpperCase();let a,analogue,caveat,conf='HIGH',horizon='‚Äî',analogueYr='‚Äî',color='#C9A84C';const cr=DATA.country_risk||{};if(k==='country_unequal'||k==='country_risk'){const list=k==='country_unequal'?(cr.top_10_unequal||cr.top_10_risk||[]):(cr.top_10_risk||cr.top_10_unequal||[]);if(!list.length){a='Country risk data not yet loaded. Run cerebro_risk_engine.py and redeploy.';analogue='';caveat='‚ö† Add World Bank Gini + deep data (GLOPOP-S, ISSP, GBCD, UCDP) for full rankings.';}else{const names=list.slice(0,10).map((r,i)=>{const n=ISO_NAMES[r.iso]||r.iso;const du=Object.entries(r.data_used||{}).map(([k,v])=>v?k+' ‚úì':k+' ‚úó').join(' ');const giniStr=r.gini!=null?`Gini ${r.gini} (${r.gini_year||''})`:'';return `${i+1}. ${n} (${r.iso}): ${k==='country_unequal'&&giniStr?giniStr+' | ':''}Risk ${r.risk_score} | Prob ${r.probability_2030} | ${(r.drivers||[]).join('; ')} | Data: ${du}`;});a=names.join('\n');const probCounts={low:0,medium:0,high:0};list.forEach(r=>{const p=r.probability_2030||'low';probCounts[p]=(probCounts[p]||0)+1;});analogue=`<strong>Risk algorithm:</strong> ${cr.algorithm||'Gini√ó0.3 + Polarization√ó0.25 + Redistribution√ó0.2 + Migration√ó0.15 + UCDP√ó0.1'}. Sources: WDI ${cr.sources_available?.WDI?'‚úì':'‚úó'} | GLOPOP-S ${cr.sources_available?.['GLOPOP-S']?'‚úì':'‚úó'} | ISSP ${cr.sources_available?.ISSP?'‚úì':'‚úó'} | GBCD ${cr.sources_available?.GBCD?'‚úì':'‚úó'} | UCDP ${cr.sources_available?.UCDP?'‚úì':'‚úó'}.`;caveat=`Probability before 2030: ${probCounts.high||0} high, ${probCounts.medium||0} medium, ${probCounts.low||0} low. Confidence per country based on data completeness.`;}document.getElementById('respA').textContent=a;document.getElementById('respA').style.whiteSpace='pre-wrap';document.getElementById('respMeta').innerHTML=`<div class="resp-meta-item"><div class="resp-meta-key">Confidence</div><div class="resp-meta-val" style="color:${color}">${conf}</div></div><div class="resp-meta-item"><div class="resp-meta-key">Horizon</div><div class="resp-meta-val">2030</div></div><div class="resp-meta-item"><div class="resp-meta-key">Source</div><div class="resp-meta-val" style="color:#C9A84C">COUNTRY RISK</div></div>`;document.getElementById('respAnalogue').innerHTML=analogue;document.getElementById('respCaveat').innerHTML=caveat;document.getElementById('showMathBtn').style.display='none';}else if(k==='METHOD'){const md=DATA.method_data||{};const p=md.provenance||{};const dw=md.distance_weights||{};const cal=md.conformal_calibration||{};const velW=dw.vel_weight??p.distance_vel_weight??100,accW=dw.acc_weight??p.distance_acc_weight??2500;a=`‚Ä¢ Saddle rule: ${md.saddle_rule||'|v| < 0.15 AND sign(a) opposes sign(v)'}\n\n‚Ä¢ Peak window: ${md.peak_window_rule||'peak_year = now_year + weighted_median(Œît_i)'}\n\n‚Ä¢ Provenance: V_THRESH=${p.v_thresh??0.15}, distance_vel_weight=${velW}, distance_acc_weight=${accW} (learned), quantiles p${((p.quantile_lo??0.1)*100).toFixed(0)}‚Äìp${((p.quantile_hi??0.9)*100).toFixed(0)} (${p.window_label??'80% window'})\n\n‚Ä¢ Conformal:${cal?.s_hat!=null?' s_hat='+cal.s_hat+', alpha='+cal.alpha:' not applied'}`;analogue='<strong>Full method:</strong> <a href="method.html" style="color:var(--gold)">method.html</a>';caveat='';document.getElementById('respA').textContent=a;document.getElementById('respA').style.whiteSpace='pre-wrap';document.getElementById('respMeta').innerHTML=`<div class="resp-meta-item"><div class="resp-meta-key">Source</div><div class="resp-meta-val" style="color:#C9A84C">METHOD</div></div>`;document.getElementById('respAnalogue').innerHTML=analogue;document.getElementById('respCaveat').innerHTML=caveat;document.getElementById('showMathBtn').style.display='none';}else if(k==='VALIDATION'){const bt=DATA.backtest_metrics||{};const md=DATA.method_data||{};const pw=md.peak_window||{};const use80=(pw.interval_alpha??0.8)===0.8;const covCal=use80?(bt.coverage_80_calibrated??bt.coverage_80):(bt.coverage_50_calibrated??bt.coverage_50);const covRaw=use80?(bt.coverage_80):(bt.coverage_50);const covLabel=use80?'80% calibrated coverage':'50% calibrated coverage';const n=bt.n_saddles_tested??0;const mae=bt.mae_years;const med=bt.median_absolute_error_years;const lib=bt.event_library||'';const stored=bt.stored_in||'cerebro_data/backtest_metrics.json';a=`‚Ä¢ N saddles tested: ${n}\n‚Ä¢ Event categories: ${(bt.event_categories||['redistribution','policy_shift']).join(', ')}\n‚Ä¢ Stored in: ${stored}\n${mae!=null?`‚Ä¢ MAE (years): ${mae}\n‚Ä¢ Median absolute error: ${med} years\n‚Ä¢ coverage_50: ${bt.coverage_50??'‚Äî'}% | calibrated: ${bt.coverage_50_calibrated??'‚Äî'}%\n‚Ä¢ coverage_80: ${bt.coverage_80??'‚Äî'}% | calibrated: ${bt.coverage_80_calibrated??'‚Äî'}%\n‚Ä¢ ${covLabel}: ${covCal??covRaw??'‚Äî'}%`:'Run cerebro_backtest.py and redeploy.'}`;analogue=`<strong>Backtest:</strong> ${lib}`;caveat='';document.getElementById('respA').textContent=a;document.getElementById('respA').style.whiteSpace='pre-wrap';document.getElementById('respMeta').innerHTML=`<div class="resp-meta-item"><div class="resp-meta-key">Source</div><div class="resp-meta-val" style="color:#C9A84C">VALIDATION</div></div>`;document.getElementById('respAnalogue').innerHTML=analogue;document.getElementById('respCaveat').innerHTML=caveat;document.getElementById('showMathBtn').style.display='none';}else if(k==='apogee'||k==='apogee_compare'||k==='apogee_crossing'||k==='apogee_multi'){const ap=getApogeeData(),cl=getClocks(),fmtV=v=>v>0?'+'+v.toFixed(2):v.toFixed(2);if(k==='apogee_multi'){const rows=[{n:'Harm',id:'harm',yr:1968},{n:'Class',id:'class',yr:1973},{n:'Sexual',id:'sexual',yr:2016},{n:'Evil',id:'evil',yr:2003}].map(r=>{const d=computeApogeeFall(r.id);return`${r.yr} ${r.n}: ${fmtV(ap[r.id].position)} ‚Üí now ${fmtV(cl[r.id])} (fell ${d.fall.toFixed(2)})`});const vels=rows.map((_,i)=>computeApogeeFall(['harm','class','sexual','evil'][i]).velocityPerYr);const fastestIdx=vels.indexOf(Math.max(...vels));const names=['Harm','Class','Sexual','Evil'];a=rows.join('. ')+'. Fastest fall: '+names[fastestIdx]+' at '+vels[fastestIdx].toFixed(2)+'/yr.';analogue='<strong>Apogee = peak before the fall.</strong> Sexual fell 1.51 pts/yr ‚Äî 78% faster than Harm (0.85/yr).';caveat='‚úì Historical memory layer ¬∑ apogee dataset loaded.';}else if(k==='apogee_compare'){const sex=computeApogeeFall('sexual'),harm=computeApogeeFall('harm');const sexVel=sex.velocityPerYr,harmVel=harm.velocityPerYr;const pct=harmVel>0?((sexVel-harmVel)/harmVel*100).toFixed(0):0;a=`Sexual fell ${sex.fall.toFixed(1)} points in ${sex.years} years = ${sexVel.toFixed(2)}/yr. Harm fell ${harm.fall.toFixed(1)} points in ${harm.years} years = ${harmVel.toFixed(2)}/yr. Sexual fell ${pct}% faster.`;analogue='<strong>Compare apogees.</strong> Sexual (2016 +9.4) reversed in 7 years. Harm (1968 +8.2) took 52 years to fall.';caveat='‚úì Apogee comparison engine.';}else if(k==='apogee_crossing'){const pos=-4.1,vel=-0.031,acc=0.004,l1=DATA.class_velocity?.velocity_smooth??15.89;const l1Contrib=typeof l1==='number'?l1*0.002:0.03;const effVel=vel+acc*3+l1Contrib;let yrsStr;if(effVel>=0){const t=(-vel+Math.sqrt(vel*vel-2*acc*pos))/(acc||0.001);yrsStr=t>0&&t<80?t.toFixed(1):'15‚Äì25';}else yrsStr='15‚Äì25';a=`Class at ${fmtV(pos)}, velocity ${fmtV(vel)}, acceleration ${fmtV(acc)}. L1 Class velocity: ${typeof l1==='number'?fmtV(l1):'+15.89'} (cultural demand for redistribution). Acceleration loading reversal. Projected years to zero: ${yrsStr} (acceleration + L1 shorten timeline).`;analogue='<strong>Crossing projection.</strong> Uses velocity + acceleration + L1 leading indicators. No saddle detected yet ‚Äî reversal loading.';caveat='‚ö† Political capture determines direction. L1 suggests redistribution pressure building.';}else{const which=q.match(/harm|class|sexual|evil/i)?.[0]?.toLowerCase()||'harm';const d=computeApogeeFall(which);if(!d){a='Apogee data not found.';}else{a=`${d.apogee.label}: ${d.apogee.year} at ${fmtV(d.apogee.position)}. Now ${fmtV(d.current)}. Fall distance: ${d.fall.toFixed(2)}. Fall velocity: ${d.velocityPerYr.toFixed(2)}/yr over ${d.years} years.`;analogue='<strong>Apogee = historical peak before the fall.</strong>';caveat='‚úì Historical memory layer.';}}document.getElementById('respA').textContent=a;document.getElementById('respMeta').innerHTML=`<div class="resp-meta-item"><div class="resp-meta-key">Confidence</div><div class="resp-meta-val" style="color:${color}">${conf}</div></div><div class="resp-meta-item"><div class="resp-meta-key">Horizon</div><div class="resp-meta-val">${horizon}</div></div><div class="resp-meta-item"><div class="resp-meta-key">Source</div><div class="resp-meta-val" style="color:#C9A84C">APOGEE</div></div>`;document.getElementById('respAnalogue').innerHTML=analogue;document.getElementById('respCaveat').innerHTML=caveat;document.getElementById('showMathBtn').style.display='none';}else{const r=RESPONSES[k]||RESPONSES.loaded;a=r.a;analogue=r.analogue;caveat=r.caveat;if(r.dynamic&&k==='trends'&&DATA.cultural_velocity){const cv=DATA.cultural_velocity;const dir=cv.cultural_velocity_smooth>0?'toward reform':'toward punitive';a=`L1 Google Trends Cultural Velocity Index: ${cv.cultural_velocity_smooth>0?'+':''}${cv.cultural_velocity_smooth.toFixed(2)} (${dir}). Reform cluster: ${cv.reform_index} | Punitive cluster: ${cv.punitive_index}. Lead time: ${cv.lead_time_months} months before behavioral shift.`;analogue='<strong>Leading indicator.</strong> Search velocity typically precedes GSS/survey shifts by 6‚Äì18 months.';caveat='‚úì L1 layer active ‚Äî real-time cultural attention signal.'}else if(r.dynamic&&k==='trends'){a='L1 Google Trends layer not yet populated. Run cerebro_trends_loader.py and redeploy.';analogue='';caveat='‚ö† Add pytrends and run trends loader to enable.'}if(k==='wealth'){const pw=DATA.method_data?.peak_window;const haz=DATA.method_data?.hazard;const cp=DATA.method_data?.changepoint;const wl=pw?.window_label??'80% window';if(pw&&pw.window_start!=null){let confStr='';if(pw.conformal_applied===true&&pw.conformal_s_hat!=null)confStr=` Conformal widening applied (s_hat=${pw.conformal_s_hat}).`;a=`Peak pressure likely ${pw.window_start}‚Äì${pw.window_end} (${wl}).${confStr} Class Permeability saddle, velocity negative, deceleration detected. Top 3 drivers: (1) analogue-weighted median Œît = ${pw.delta_median??'‚Äî'} yr, (2) ${pw.analogue_count??0} historical episodes, (3) Ring B ${DATA.ring_b_loaded?'loaded':'pending'}. Confidence ${pw.confidence_pct??70}%.`;if(haz&&haz.prob_5y!=null)a+=` Event hazard: P(5y)=${(haz.prob_5y*100).toFixed(0)}%, E[time-to-event]=${haz.expected_time_to_event_years??'‚Äî'} yr.`;if(cp&&cp.regime_shift_probability!=null)a+=` Regime shift probability: ${(cp.regime_shift_probability*100).toFixed(0)}%.`;}else{a="Class Permeability at ‚àí4.1/10, Moderate Saddle. Trajectory suggests max pressure 2027‚Äì2032.";}const cv=DATA.class_velocity;const g=DATA.aux_indicators?.gini;let ext='';if(cv)ext+=` L1 Class velocity: ${cv.velocity_smooth>0?'+':''}${cv.velocity_smooth.toFixed(2)} (${cv.velocity_smooth>0?'redistribution gaining':'extraction gaining'}).`;if(g!=null)ext+=` Gini: ${g}.`;a=a+ext;}if(k==='sexual'&&(DATA.sexual_velocity||DATA.aux_indicators?.sti_rate)){const cv=DATA.sexual_velocity;const sti=DATA.aux_indicators?.sti_rate;let ext='';if(sti!=null)ext+=` STI combined rate: ${sti}/100k (chlamydia+gonorrhea).`;if(cv)ext+=` L1 Sexual velocity: ${cv.velocity_smooth>0?'+':''}${cv.velocity_smooth.toFixed(2)} (${cv.velocity_smooth>0?'autonomy gaining':'constraint gaining'}).`;a=a+ext;}document.getElementById('respA').textContent=a;document.getElementById('respMeta').innerHTML=`<div class="resp-meta-item"><div class="resp-meta-key">Confidence</div><div class="resp-meta-val" style="color:${r.color}">${r.confidence}</div></div><div class="resp-meta-item"><div class="resp-meta-key">Horizon</div><div class="resp-meta-val">${r.horizon}</div></div><div class="resp-meta-item"><div class="resp-meta-key">Analogue</div><div class="resp-meta-val" style="color:#C9A84C">${r.analogue_yr}</div></div>`;document.getElementById('respAnalogue').innerHTML=analogue;document.getElementById('respCaveat').innerHTML=caveat;document.getElementById('showMathBtn').style.display='inline-block';document.getElementById('showMathBtn').textContent='SHOW MATH';document.getElementById('respMath').style.display='none';}document.getElementById('oracleResponse').classList.add('visible');document.getElementById('oracleResponse').scrollIntoView({behavior:'smooth'});}
function drillClock(id){setQuery(id==='harm'?'Are we heading into a punitive crime era?':id==='sexual'?'Is a conservative sexual norm backlash coming?':id==='class'?'When does the wealth redistribution crisis peak?':'How loaded is the system right now?')}
function updateDataBadge(){
  const b=document.getElementById('dataBadge');
  if(!b)return;
  const offline=!navigator.onLine;
  const backup=(DATA.system||{}).backup_active;
  if(offline){b.textContent='LIVE DATA OFFLINE';b.style.color='#FF9F1C';}
  else if(backup){b.textContent='BACKUP ACTIVE';b.style.color='#FF9F1C';}
  else{b.textContent='';b.style.color='var(--muted)';}
}
let RETRY_MS=60000;
let retryTimer=null;
function loadData(){
  const urls=['cerebro_data.json','cerebro_offline.json'];
  function tryFetch(i){
    if(i>=urls.length){
      try{const cached=localStorage.getItem('cerebro_cache');if(cached){DATA=JSON.parse(cached);renderAll();scheduleRetry();return;}}catch(e){}
      DATA=FALLBACK;renderAll();scheduleRetry();return;
    }
    fetch(urls[i]).then(r=>r.json()).then(d=>{DATA=d;try{localStorage.setItem('cerebro_cache',JSON.stringify(d));}catch(e){};cancelRetry();renderAll();}).catch(()=>tryFetch(i+1));
  }
  tryFetch(0);
}
function scheduleRetry(){if(retryTimer)clearTimeout(retryTimer);retryTimer=setTimeout(loadData,RETRY_MS);}
function cancelRetry(){if(retryTimer){clearTimeout(retryTimer);retryTimer=null;}}
function syncNow(){const btn=document.getElementById('syncBtn');if(btn)btn.disabled=true;loadData();setTimeout(()=>{if(btn)btn.disabled=false;},2000);}
function buildFigure8(){
  const f8=DATA.figure8||{};const hon=f8.honeycomb||{};const sim=f8.forward_simulation||{};const shift=f8.distribution_shift||{};
  const honEl=document.getElementById('figure8Honeycomb');if(!honEl)return;
  if(hon.error||!hon.peak_year){honEl.innerHTML=hon.error||'<div class="figure8-placeholder">Run cerebro_honeycomb.py to load</div>';}else{
    const c=hon.components||{};const core=c.core||{};const sis=c.sister||{};const simc=c.simulation||{};
    honEl.innerHTML=`<div class="data-row"><span class="data-key">Peak year</span><span class="data-val" style="color:var(--gold)">${hon.peak_year}</span></div>`
      +`<div class="data-row"><span class="data-key">Window</span><span class="data-val">${hon.window_start}‚Äì${hon.window_end}</span></div>`
      +`<div class="data-row"><span class="data-key">Confidence</span><span class="data-val">${hon.confidence_pct}%</span></div>`
      +`<div class="data-row"><span class="data-key">Disagreement (œÉ)</span><span class="data-val">${hon.disagreement_std_years??'‚Äî'} yr</span></div>`
      +`<div style="margin-top:12px;font-size:9px;color:var(--dim)">Components: Core ${core.peak_year??'‚Äî'} | Sister ${sis.peak_year??'‚Äî'} | Sim ${simc.peak_year??'‚Äî'}</div>`;
  }
  const simEl=document.getElementById('figure8Sim');if(!simEl)return;
  if(sim.error||(!sim.event_probability_5yr&&!sim.median_time_to_event)){simEl.innerHTML=sim.error||'<div class="figure8-placeholder">Run cerebro_forward_simulation.py to load</div>';}else{
    const p5=(sim.event_probability_5yr??0)*100;const p10=(sim.event_probability_10yr??0)*100;const med=sim.median_time_to_event??'‚Äî';
    let hist='';const dist=sim.distribution||{};const yrs=Object.keys(dist).filter(k=>/^\d+$/.test(k)).map(Number).sort((a,b)=>a-b);
    if(yrs.length){const max=Math.max(...yrs.map(y=>dist[String(y)]||0));yrs.slice(0,15).forEach(y=>{const v=dist[String(y)]||0;const pct=max>0?(v/max)*100:0;hist+=`<div class="figure8-bar"><span style="min-width:24px">${y}yr</span><div class="figure8-bar-fill" style="width:${Math.max(2,pct)}%"></div><span style="color:var(--muted)">${(v*100).toFixed(1)}%</span></div>`;});}
    simEl.innerHTML=`<div class="data-row"><span class="data-key">P(5yr)</span><span class="data-val">${p5.toFixed(0)}%</span></div>`
      +`<div class="data-row"><span class="data-key">P(10yr)</span><span class="data-val">${p10.toFixed(0)}%</span></div>`
      +`<div class="data-row"><span class="data-key">Median time-to-event</span><span class="data-val">${med} yr</span></div>`
      +`<div style="margin-top:12px;font-size:9px;color:var(--dim)">Distribution</div>${hist||'<div class="figure8-placeholder">‚Äî</div>'}`;
  }
  const shiftEl=document.getElementById('figure8Shift');if(!shiftEl)return;
  if(shift.error||(shift.percentile==null&&!shift.confidence_modifier)){shiftEl.innerHTML=shift.error||'<div class="figure8-placeholder">Run cerebro_distribution_shift.py to load</div>';}else{
    const pct=shift.percentile??0;const mod=shift.confidence_modifier??1;const warn=pct>0.95?'<div class="figure8-warn">Out-of-distribution risk: extrapolating</div>':'';
    shiftEl.innerHTML=`<div class="data-row"><span class="data-key">Percentile</span><span class="data-val">${(pct*100).toFixed(1)}%</span></div>`
      +`<div class="data-row"><span class="data-key">Confidence modifier</span><span class="data-val">${mod}</span></div>${warn}`;
  }
}
function renderAll(){
  buildTicker();buildCPI();buildClocks();buildTickerBottom();buildDensityPanel();buildFigure8();updateDataBadge();
  const d=DATA,sys=d.system||{},conf=sys.confidence_pct||85,layers=[];if(d.cultural_velocity)layers.push('L1 HARM');if(d.class_velocity)layers.push('L1 CLASS');if(d.sexual_velocity)layers.push('L1 SEXUAL');
  const l1=layers.length?' + '+layers.join(' + '):'';
  const cal=DATA.calibration_curve;const calNote=cal&&cal.bins?.length?' ¬∑ Confidence calibrated against historical reliability':'';
  const hc=DATA.hazard_curve;const hazNote=hc&&hc.P_5yr!=null?` ¬∑ P(5yr)=${(hc.P_5yr*100).toFixed(0)}%`:('');
  const ens=DATA.ensemble||{};const sis=ens.sister_hazard||{};const hon=ens.honeycomb_hazard||{};
  const modelStack=(sis.P_5yr!=null||hon.P_5yr!=null)?`<br><span style="font-size:9px;color:var(--dim)">Model stack: Core ${((hc?.P_5yr??0)*100).toFixed(0)}% ¬∑ Sister ${((sis.P_5yr??0)*100).toFixed(0)}% ¬∑ Honeycomb ${((hon.P_5yr??0)*100).toFixed(0)}% ¬∑ ${(hon.w_core??0.5)>=0.5?'Core‚Üë':'Sister‚Üë'}</span>`:'';
  const reg=DATA.regime_probabilities;const regNote=reg&&reg.Redistribution!=null?` ¬∑ Regime: ${Object.entries(reg).sort((a,b)=>b[1]-a[1]).slice(0,2).map(([k,v])=>k+' '+(v*100).toFixed(0)+'%').join(', ')}`:('');
  const pt=DATA.placebo_test;const placeboNote=pt&&pt.p_value_brier!=null?`<br><span style="font-size:9px;color:var(--dim)">Placebo p_brier=${pt.p_value_brier} ¬∑ p_coverage=${pt.p_value_coverage}</span>`:'';
  const cs=DATA.candidate_sweep;let sweepBadge='';if(cs&&cs.sweep?.length>=2){const covs=cs.sweep.map(s=>s.coverage_80).filter(x=>x!=null);const briers=cs.sweep.map(s=>s.brier).filter(x=>x!=null);const m=(a)=>a.reduce((x,y)=>x+y,0)/a.length;const covStd=covs.length>=2?Math.sqrt(covs.reduce((a,v)=>a+(v-m(covs))**2,0)/(covs.length-1)):0;const brierStd=briers.length>=2?Math.sqrt(briers.reduce((a,v)=>a+(v-m(briers))**2,0)/(briers.length-1)):0;if(covStd<0.1&&brierStd<0.05)sweepBadge=' ¬∑ <span style="font-size:9px;color:var(--green)">stable across thresholds</span>';}
  const fl=document.getElementById('footerLeft');if(fl)fl.innerHTML=`<span class="live-dot"></span>LIVE DATA ¬∑ FRED + GSS + PEW + STI + UCDP${l1}<br>RING B LOADED ¬∑ CONFIDENCE ${conf}%${calNote}${hazNote}${regNote}${sweepBadge}${placeboNote}${modelStack}<button class="sync-btn" id="syncBtn" onclick="syncNow()" title="Sync when connection restored">SYNC</button>`;
}
loadData();
window.addEventListener('online',updateDataBadge);
window.addEventListener('offline',()=>{updateDataBadge();const b=document.getElementById('dataBadge');if(b)b.textContent='LIVE DATA OFFLINE';b.style.color='#FF9F1C'});
</script>
</body>
</html>
